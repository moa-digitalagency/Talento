{% extends 'base.html' %}

{% block title %}Fiche Talent - {{ user.full_name }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-indigo-600">Fiche Talent</h1>
        <div class="flex gap-3">
            <a href="{{ url_for('admin.dashboard') }}" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                ‚Üê Retour
            </a>
            <a href="{{ url_for('admin.export_pdf', user_id=user.id) }}" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                üìÑ Exporter PDF
            </a>
        </div>
    </div>

    <div class="bg-white shadow-lg rounded-lg overflow-hidden">
        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-6 text-white">
            <div class="flex items-center gap-6">
                {% if user.photo_filename %}
                <img src="{{ url_for('static', filename='uploads/photos/' + user.photo_filename) }}" 
                     alt="{{ user.full_name }}"
                     class="w-32 h-32 rounded-full border-4 border-white object-cover">
                {% else %}
                <div class="w-32 h-32 rounded-full border-4 border-white bg-indigo-300 flex items-center justify-center text-5xl">
                    üë§
                </div>
                {% endif %}
                
                <div class="flex-1">
                    <h2 class="text-3xl font-bold">{{ user.full_name }}</h2>
                    <p class="text-indigo-100 text-lg">{{ user.email }}</p>
                    <p class="text-indigo-100 mt-2">Code unique: <span class="font-mono bg-white/20 px-3 py-1 rounded">{{ user.formatted_code }}</span></p>
                    <div class="mt-3 flex gap-3">
                        <span class="bg-yellow-400 text-yellow-900 px-3 py-1 rounded-full text-sm font-semibold">
                            Score: {{ user.profile_score or 0 }}/100
                        </span>
                        {% if user.is_admin %}
                        <span class="bg-red-500 text-white px-3 py-1 rounded-full text-sm">Admin</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="border-l-4 border-blue-500 pl-4">
                <h3 class="text-xl font-bold text-blue-600 mb-3">üìû Contact</h3>
                <p><strong>T√©l√©phone:</strong> {{ user.phone or 'Non renseign√©' }}</p>
                <p><strong>WhatsApp:</strong> {{ user.whatsapp or 'Non renseign√©' }}</p>
                <p><strong>Adresse:</strong> {{ user.address or 'Non renseign√©e' }}</p>
            </div>

            <div class="border-l-4 border-green-500 pl-4">
                <h3 class="text-xl font-bold text-green-600 mb-3">üåç Localisation</h3>
                <p><strong>Pays d'origine:</strong> {{ user.country.name if user.country else 'Non renseign√©' }}</p>
                <p><strong>Ville au Maroc:</strong> {{ user.city.name if user.city else 'Non renseign√©e' }}</p>
                <p><strong>Genre:</strong> 
                    {% if user.gender == 'M' %}Masculin
                    {% elif user.gender == 'F' %}F√©minin
                    {% else %}Non pr√©cis√©{% endif %}
                </p>
                <p><strong>Date de naissance:</strong> {{ user.date_of_birth.strftime('%d/%m/%Y') if user.date_of_birth else 'Non renseign√©e' }}</p>
            </div>

            <div class="border-l-4 border-purple-500 pl-4">
                <h3 class="text-xl font-bold text-purple-600 mb-3">üíº Profil Professionnel</h3>
                <p><strong>Disponibilit√©:</strong> {{ user.availability or 'Non renseign√©e' }}</p>
                <p><strong>Mode de travail:</strong> {{ user.work_mode or 'Non renseign√©' }}</p>
                <p><strong>Fourchette tarifaire:</strong> {{ user.rate_range or 'Non renseign√©e' }}</p>
                <p><strong>Ann√©es d'exp√©rience:</strong> {{ user.years_experience or 'Non renseign√©' }}</p>
            </div>

            <div class="border-l-4 border-yellow-500 pl-4">
                <h3 class="text-xl font-bold text-yellow-600 mb-3">üìÑ Documents</h3>
                <p><strong>CV:</strong> 
                    {% if user.cv_filename %}
                    <a href="{{ url_for('static', filename='uploads/cvs/' + user.cv_filename) }}" 
                       class="text-blue-600 hover:underline" target="_blank">T√©l√©charger</a>
                    <button onclick="analyzeCV({{ user.id }})" class="ml-2 text-sm bg-indigo-500 text-white px-2 py-1 rounded hover:bg-indigo-600">
                        ü§ñ Analyser
                    </button>
                    {% else %}Non fourni{% endif %}
                </p>
                <p><strong>Portfolio:</strong> 
                    {% if user.portfolio_url %}
                    <a href="{{ user.portfolio_url }}" class="text-blue-600 hover:underline" target="_blank">Voir</a>
                    {% else %}Non fourni{% endif %}
                </p>
                <p><strong>QR Code:</strong> 
                    {% if user.qr_code_filename %}
                    <a href="{{ url_for('static', filename='uploads/qrcodes/' + user.qr_code_filename) }}" 
                       class="text-blue-600 hover:underline" target="_blank">T√©l√©charger</a>
                    {% else %}Non g√©n√©r√©{% endif %}
                </p>
            </div>
        </div>

        {% if user.talents %}
        <div class="p-6 bg-gray-50">
            <h3 class="text-xl font-bold text-indigo-600 mb-4 flex items-center gap-2">
                <img src="{{ url_for('static', filename='img/logo.svg') }}" alt="" class="w-6 h-6">
                Talents & Comp√©tences
            </h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                {% for ut in user.talents %}
                <div class="bg-white border-2 border-indigo-200 rounded-lg p-3 text-center hover:shadow-md transition">
                    <div class="text-3xl mb-1">{{ ut.talent.emoji }}</div>
                    <div class="font-semibold text-sm">{{ ut.talent.name }}</div>
                    <div class="text-xs text-gray-500">{{ ut.talent.category }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if user.bio %}
        <div class="p-6">
            <h3 class="text-xl font-bold text-indigo-600 mb-3">üìù Biographie</h3>
            <p class="text-gray-700">{{ user.bio }}</p>
        </div>
        {% endif %}

        <div class="p-6 bg-gray-50">
            <h3 class="text-xl font-bold text-indigo-600 mb-4">üåê R√©seaux Sociaux</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                {% for platform in ['linkedin', 'instagram', 'twitter', 'facebook', 'github', 'behance', 'dribbble', 'youtube'] %}
                {% set value = user[platform] %}
                {% if value %}
                <a href="{{ value }}" target="_blank" class="bg-white border rounded-lg p-3 hover:shadow-md hover:bg-indigo-50 transition flex items-center gap-2">
                    <span class="capitalize font-semibold text-sm">{{ platform }}</span>
                </a>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        {% if user.cv_analysis %}
        <div class="p-6 bg-blue-50">
            <h3 class="text-xl font-bold text-blue-600 mb-4">ü§ñ Analyse IA du CV</h3>
            <div id="cv-analysis">
                {{ user.cv_analysis | safe }}
            </div>
        </div>
        {% endif %}

        <div class="p-6 bg-gray-100 text-sm text-gray-600">
            <p><strong>Date d'inscription:</strong> {{ user.created_at.strftime('%d/%m/%Y √† %H:%M') if user.created_at else 'N/A' }}</p>
            <p><strong>Derni√®re mise √† jour:</strong> {{ user.updated_at.strftime('%d/%m/%Y √† %H:%M') if user.updated_at else 'N/A' }}</p>
            {% if user.cv_analyzed_at %}
            <p><strong>CV analys√© le:</strong> {{ user.cv_analyzed_at.strftime('%d/%m/%Y √† %H:%M') }}</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
function analyzeCV(userId) {
    if (!confirm('Analyser le CV de cet utilisateur avec l\'IA ? Cela peut prendre quelques secondes.')) {
        return;
    }
    
    fetch(`/admin/user/${userId}/analyze_cv`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Analyse termin√©e!\nScore: ${data.analysis.score}/100`);
            location.reload();
        } else {
            alert(`Erreur: ${data.error}`);
        }
    })
    .catch(error => {
        alert('Erreur lors de l\'analyse: ' + error);
    });
}
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}ParamÃ¨tres - Administration - TalentsMaroc.com{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-4 px-4">
    <div class="max-w-7xl mx-auto">
        
        <!-- Header -->
        <div class="mb-4">
            <h1 class="text-3xl font-bold text-gray-800 mb-1">âš™ï¸ ParamÃ¨tres</h1>
            <p class="text-gray-600 text-sm">Configuration de l'application et gestion des administrateurs</p>
        </div>

        <!-- Messages Flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="mb-3 p-2 rounded-lg border-2 {% if category == 'success' %}bg-green-50 border-green-300 text-green-800{% elif category == 'error' %}bg-red-50 border-red-300 text-red-800{% else %}bg-blue-50 border-blue-300 text-blue-800{% endif %}">
                    {{ message }}
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Grid de blocs avec tout le contenu intÃ©grÃ© -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            
            <!-- 1. ClÃ©s API - Configuration SendGrid -->
            <div class="bg-blue-50 border-2 border-dashed border-blue-400 rounded-lg p-4 hover:shadow-lg transition-all">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-2xl">ğŸ”‘</span>
                    <h3 class="text-base font-bold text-gray-800">ClÃ©s API</h3>
                </div>
                <p class="text-xs text-gray-600 mb-3">Configurer les clÃ©s API</p>
                
                <form method="POST" action="{{ url_for('admin.save_settings') }}" class="space-y-2">
                    <!-- SendGrid -->
                    <div class="bg-white p-2 rounded border">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-xs font-bold">ğŸ“§ SendGrid</span>
                            <span class="px-1 py-0.5 rounded text-xs {% if config.sendgrid %}bg-green-100 text-green-700{% else %}bg-orange-100 text-orange-700{% endif %}">
                                {% if config.sendgrid %}âœ…{% else %}âš ï¸{% endif %}
                            </span>
                        </div>
                        <input type="password" 
                               name="sendgrid_api_key" 
                               value="{{ config.sendgrid_key_masked }}" 
                               placeholder="SG.xxx..."
                               class="w-full px-2 py-1 border rounded text-xs font-mono">
                    </div>
                    
                    <!-- OpenRouter -->
                    <div class="bg-white p-2 rounded border">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-xs font-bold">ğŸ¤– OpenRouter</span>
                            <span class="px-1 py-0.5 rounded text-xs {% if config.openrouter %}bg-green-100 text-green-700{% else %}bg-orange-100 text-orange-700{% endif %}">
                                {% if config.openrouter %}âœ…{% else %}âš ï¸{% endif %}
                            </span>
                        </div>
                        <input type="password" 
                               name="openrouter_api_key" 
                               value="{{ config.openrouter_key_masked }}" 
                               placeholder="sk-or-v1-xxx..."
                               class="w-full px-2 py-1 border rounded text-xs font-mono">
                    </div>
                    
                    <!-- Email ExpÃ©diteur -->
                    <div class="bg-white p-2 rounded border">
                        <span class="text-xs font-bold">âœ‰ï¸ Email expÃ©diteur</span>
                        <input type="email" 
                               name="sender_email" 
                               value="{{ config.sendgrid_from }}" 
                               placeholder="noreply@example.com"
                               class="w-full px-2 py-1 border rounded text-xs mt-1">
                    </div>
                    
                    <button type="submit" class="w-full px-3 py-1.5 bg-white text-blue-600 font-bold rounded border-2 border-blue-600 hover:bg-blue-50 transition-all text-xs">
                        ğŸ’¾ Enregistrer
                    </button>
                </form>
            </div>

            <!-- 2. SÃ©curitÃ© - Backup & Restauration -->
            <div class="bg-red-50 border-2 border-dashed border-red-400 rounded-lg p-4 hover:shadow-lg transition-all">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-2xl">â¤ï¸</span>
                    <h3 class="text-base font-bold text-gray-800">SÃ©curitÃ©</h3>
                </div>
                <p class="text-xs text-gray-600 mb-3">Sauvegardes et sÃ©curitÃ©</p>
                
                <div class="space-y-2">
                    <form method="POST" action="{{ url_for('admin.create_backup') }}">
                        <button type="submit" class="w-full px-3 py-1.5 bg-white text-red-600 font-bold rounded border-2 border-red-600 hover:bg-red-50 transition-all text-xs">
                            ğŸ’¾ CrÃ©er une sauvegarde
                        </button>
                    </form>
                    
                    <div class="bg-white p-2 rounded border">
                        <span class="text-xs font-bold block mb-1">ğŸ”’ Changer mot de passe</span>
                        <p class="text-xs text-gray-500">Via profil utilisateur</p>
                    </div>
                    
                    <div class="bg-white p-2 rounded border">
                        <span class="text-xs font-bold block mb-1">ğŸ” Sessions actives</span>
                        <p class="text-xs text-gray-500">Vous Ãªtes connectÃ©</p>
                    </div>
                </div>
            </div>

            <!-- 3. DÃ©partements - Gestion des Utilisateurs -->
            <div class="bg-emerald-50 border-2 border-dashed border-emerald-400 rounded-lg p-4 hover:shadow-lg transition-all">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-2xl">ğŸ¢</span>
                    <h3 class="text-base font-bold text-gray-800">DÃ©partements</h3>
                </div>
                <p class="text-xs text-gray-600 mb-3">Structure organisationnelle</p>
                
                <div class="space-y-2">
                    <a href="{{ url_for('admin.users') }}" class="block w-full px-3 py-1.5 bg-white text-emerald-600 font-bold rounded border-2 border-emerald-600 hover:bg-emerald-50 transition-all text-xs text-center">
                        ğŸ‘¥ Voir tous les utilisateurs
                    </a>
                    
                    <a href="{{ url_for('admin.talents') }}" class="block w-full px-3 py-1.5 bg-white text-emerald-600 font-bold rounded border-2 border-emerald-600 hover:bg-emerald-50 transition-all text-xs text-center">
                        â­ Voir tous les talents
                    </a>
                    
                    <div class="bg-white p-2 rounded border">
                        <div class="flex justify-between items-center">
                            <span class="text-xs font-bold">Total utilisateurs</span>
                            <span class="text-xs font-mono">{{ admin_users|length }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. Types Sortants - Promouvoir Admin -->
            <div class="bg-purple-50 border-2 border-dashed border-purple-400 rounded-lg p-4 hover:shadow-lg transition-all">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-2xl">ğŸ‘¨â€ğŸ’¼</span>
                    <h3 class="text-base font-bold text-gray-800">Types Sortants</h3>
                </div>
                <p class="text-xs text-gray-600 mb-3">GÃ©rer les types de profils</p>
                
                <div class="space-y-2">
                    <a href="{{ url_for('admin.create_admin_user') }}" class="block w-full px-3 py-1.5 bg-white text-purple-600 font-bold rounded border-2 border-purple-600 hover:bg-purple-50 transition-all text-xs text-center">
                        â• CrÃ©er un admin
                    </a>
                    
                    <form method="POST" action="#" id="promote-form" onsubmit="return confirmPromotion();" class="space-y-1">
                        <select name="user_id" id="user-select" class="w-full px-2 py-1 border-2 border-purple-300 rounded text-xs" required>
                            <option value="">-- Promouvoir utilisateur --</option>
                        </select>
                        <div class="flex gap-1">
                            <button type="button" onclick="loadNonAdminUsers()" class="flex-1 px-2 py-1 bg-white text-blue-600 font-semibold rounded border border-blue-600 hover:bg-blue-50 text-xs">
                                Charger
                            </button>
                            <button type="submit" class="flex-1 px-2 py-1 bg-white text-purple-600 font-semibold rounded border border-purple-600 hover:bg-purple-50 text-xs">
                                Promouvoir
                            </button>
                        </div>
                    </form>
                </div>
                
                <script>
                    function loadNonAdminUsers() {
                        fetch('/admin/users')
                            .then(response => response.text())
                            .then(html => {
                                const parser = new DOMParser();
                                const doc = parser.parseFromString(html, 'text/html');
                                const select = document.getElementById('user-select');
                                select.innerHTML = '<option value="">-- Promouvoir utilisateur --</option>';
                                
                                const rows = doc.querySelectorAll('tbody tr');
                                rows.forEach(row => {
                                    const cells = row.querySelectorAll('td');
                                    if (cells.length >= 3) {
                                        const code = cells[0].textContent.trim();
                                        const name = cells[1].textContent.trim();
                                        const userId = row.querySelector('a[href*="edit"]')?.href.match(/\/(\d+)\/edit/)?.[1];
                                        
                                        if (userId) {
                                            const option = document.createElement('option');
                                            option.value = userId;
                                            option.textContent = `${name} (${code})`;
                                            select.appendChild(option);
                                        }
                                    }
                                });
                                
                                if (select.options.length === 1) {
                                    alert('Aucun utilisateur non-admin trouvÃ©');
                                }
                            })
                            .catch(error => {
                                console.error('Erreur:', error);
                                alert('Impossible de charger les utilisateurs');
                            });
                    }

                    function confirmPromotion() {
                        const select = document.getElementById('user-select');
                        const selectedOption = select.options[select.selectedIndex];
                        
                        if (!select.value) {
                            alert('Veuillez sÃ©lectionner un utilisateur');
                            return false;
                        }
                        
                        const confirmed = confirm(`ÃŠtes-vous sÃ»r de vouloir promouvoir ${selectedOption.text} en administrateur ?`);
                        if (confirmed) {
                            document.getElementById('promote-form').action = `/admin/user/${select.value}/promote-admin`;
                            return true;
                        }
                        return false;
                    }
                </script>
            </div>

            <!-- 5. Templates Email - Test Email -->
            <div class="bg-indigo-50 border-2 border-dashed border-indigo-400 rounded-lg p-4 hover:shadow-lg transition-all">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-2xl">âœ‰ï¸</span>
                    <h3 class="text-base font-bold text-gray-800">Templates Email</h3>
                </div>
                <p class="text-xs text-gray-600 mb-3">Tester l'envoi d'emails</p>
                
                <form method="POST" action="{{ url_for('admin.test_email') }}" class="space-y-2">
                    <div class="bg-white p-2 rounded border">
                        <label class="block text-xs font-bold mb-1">Email destinataire</label>
                        <input type="email" 
                               name="test_email" 
                               placeholder="test@exemple.com"
                               required
                               class="w-full px-2 py-1 border rounded text-xs">
                    </div>
                    
                    <button type="submit" 
                            {% if not config.sendgrid %}disabled{% endif %}
                            class="w-full px-3 py-1.5 {% if config.sendgrid %}bg-white text-indigo-600 border-2 border-indigo-600 hover:bg-indigo-50{% else %}bg-gray-100 text-gray-400 border-2 border-gray-300 cursor-not-allowed{% endif %} font-bold rounded transition-all text-xs">
                        ğŸ“® Envoyer un test
                    </button>
                    
                    {% if not config.sendgrid %}
                    <p class="text-xs text-orange-600">âš ï¸ Configurez SendGrid d'abord</p>
                    {% endif %}
                </form>
            </div>

            <!-- 6. Sauvegardes - Historique -->
            <div class="bg-orange-50 border-2 border-dashed border-orange-400 rounded-lg p-4 hover:shadow-lg transition-all">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-2xl">ğŸ’¾</span>
                    <h3 class="text-base font-bold text-gray-800">Sauvegardes</h3>
                </div>
                <p class="text-xs text-gray-600 mb-3">GÃ©rer les sauvegardes</p>
                
                <div class="space-y-2">
                    <form method="POST" action="{{ url_for('admin.create_backup') }}">
                        <button type="submit" class="w-full px-3 py-1.5 bg-white text-orange-600 font-bold rounded border-2 border-orange-600 hover:bg-orange-50 transition-all text-xs">
                            ğŸ“¦ CrÃ©er sauvegarde
                        </button>
                    </form>
                    
                    <div class="bg-white p-2 rounded border">
                        <span class="text-xs font-bold block mb-1">ğŸ“‚ DerniÃ¨re sauvegarde</span>
                        <p class="text-xs text-gray-500">Aucune disponible</p>
                    </div>
                    
                    <div class="bg-white p-2 rounded border">
                        <span class="text-xs font-bold block mb-1">â±ï¸ Automatique</span>
                        <p class="text-xs text-gray-500">Non configurÃ©</p>
                    </div>
                </div>
            </div>

            <!-- 7. Gestion des RÃ´les - Liste Admins -->
            <div class="bg-pink-50 border-2 border-dashed border-pink-400 rounded-lg p-4 hover:shadow-lg transition-all">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-2xl">ğŸ‘¥</span>
                    <h3 class="text-base font-bold text-gray-800">Gestion des RÃ´les</h3>
                </div>
                <p class="text-xs text-gray-600 mb-3">Administrateurs systÃ¨me</p>
                
                <div class="space-y-1 max-h-48 overflow-y-auto">
                    {% for admin in admin_users %}
                    <div class="bg-white p-2 rounded border flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            {% if admin.photo_filename %}
                            <img src="{{ url_for('static', filename='uploads/photos/' + admin.photo_filename) }}" 
                                 alt="{{ admin.full_name }}" 
                                 class="w-6 h-6 rounded-full object-cover">
                            {% else %}
                            <div class="w-6 h-6 rounded-full bg-pink-500 flex items-center justify-center text-white text-xs font-bold">
                                {{ admin.first_name[0] if admin.first_name else '?' }}
                            </div>
                            {% endif %}
                            <div>
                                <div class="text-xs font-medium">{{ admin.full_name }}</div>
                                <div class="text-xs text-gray-500">{{ admin.email }}</div>
                            </div>
                        </div>
                        {% if admin.id == current_user.id %}
                        <span class="text-xs text-pink-600 font-bold">Vous</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- 8. Gestion des Langues - Database Info -->
            <div class="bg-cyan-50 border-2 border-dashed border-cyan-400 rounded-lg p-4 hover:shadow-lg transition-all">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-2xl">ğŸ—„ï¸</span>
                    <h3 class="text-base font-bold text-gray-800">Gestion des Langues</h3>
                </div>
                <p class="text-xs text-gray-600 mb-3">Base de donnÃ©es et langues</p>
                
                <div class="space-y-2">
                    <div class="bg-white p-2 rounded border">
                        <div class="flex justify-between items-center">
                            <span class="text-xs font-bold">Type BD</span>
                            <span class="text-xs font-mono">{{ config.database_type }}</span>
                        </div>
                    </div>
                    
                    <div class="bg-white p-2 rounded border">
                        <div class="flex justify-between items-center">
                            <span class="text-xs font-bold">Ã‰tat</span>
                            <span class="text-xs {% if db_diagnostics.connection_ok %}text-green-600{% else %}text-red-600{% endif %}">
                                {% if db_diagnostics.connection_ok %}âœ… ConnectÃ©e{% else %}âŒ DÃ©connectÃ©e{% endif %}
                            </span>
                        </div>
                    </div>
                    
                    {% if db_diagnostics.tables %}
                    <div class="bg-white p-2 rounded border">
                        <span class="text-xs font-bold block mb-1">ğŸ“Š Tables</span>
                        <div class="flex flex-wrap gap-1">
                            {% for table in db_diagnostics.tables[:6] %}
                            <span class="text-xs bg-cyan-100 px-1 py-0.5 rounded">{{ table }}</span>
                            {% endfor %}
                            {% if db_diagnostics.tables|length > 6 %}
                            <span class="text-xs text-gray-500">+{{ db_diagnostics.tables|length - 6 }}</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- 9. Logs d'ActivitÃ©s -->
            <div class="bg-blue-50 border-2 border-dashed border-blue-400 rounded-lg p-4 hover:shadow-lg transition-all">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-2xl">ğŸ“Š</span>
                    <h3 class="text-base font-bold text-gray-800">Logs d'ActivitÃ©s</h3>
                </div>
                <p class="text-xs text-gray-600 mb-3">Historique des actions</p>
                
                <div class="space-y-2">
                    <div class="bg-white p-2 rounded border">
                        <span class="text-xs font-bold block mb-1">ğŸ“ DerniÃ¨res actions</span>
                        <p class="text-xs text-gray-500">Aucun log disponible</p>
                    </div>
                    
                    <button class="w-full px-3 py-1.5 bg-white text-blue-600 font-bold rounded border-2 border-blue-600 hover:bg-blue-50 transition-all text-xs">
                        ğŸ“„ Voir tous les logs
                    </button>
                </div>
            </div>

            <!-- 10. Vider les Caches -->
            <div class="bg-yellow-50 border-2 border-dashed border-yellow-400 rounded-lg p-4 hover:shadow-lg transition-all">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-2xl">ğŸ§¹</span>
                    <h3 class="text-base font-bold text-gray-800">Vider les Caches</h3>
                </div>
                <p class="text-xs text-gray-600 mb-3">Optimiser les performances</p>
                
                <div class="space-y-2">
                    <button class="w-full px-3 py-1.5 bg-white text-yellow-600 font-bold rounded border-2 border-yellow-600 hover:bg-yellow-50 transition-all text-xs">
                        ğŸ—‘ï¸ Vider cache navigateur
                    </button>
                    
                    <button class="w-full px-3 py-1.5 bg-white text-yellow-600 font-bold rounded border-2 border-yellow-600 hover:bg-yellow-50 transition-all text-xs">
                        ğŸ”„ Vider cache serveur
                    </button>
                    
                    <div class="bg-white p-2 rounded border">
                        <span class="text-xs font-bold block mb-1">ğŸ’¾ Espace utilisÃ©</span>
                        <p class="text-xs text-gray-500">Calcul en cours...</p>
                    </div>
                </div>
            </div>

            <!-- 11. Logs de SÃ©curitÃ© -->
            <div class="bg-red-50 border-2 border-dashed border-red-400 rounded-lg p-4 hover:shadow-lg transition-all">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-2xl">ğŸ”’</span>
                    <h3 class="text-base font-bold text-gray-800">Logs de SÃ©curitÃ©</h3>
                </div>
                <p class="text-xs text-gray-600 mb-3">Ã‰vÃ©nements de sÃ©curitÃ©</p>
                
                <div class="space-y-2">
                    <div class="bg-white p-2 rounded border">
                        <span class="text-xs font-bold block mb-1">ğŸš¨ Tentatives Ã©chouÃ©es</span>
                        <p class="text-xs text-gray-500">0 cette semaine</p>
                    </div>
                    
                    <div class="bg-white p-2 rounded border">
                        <span class="text-xs font-bold block mb-1">âœ… Connexions rÃ©ussies</span>
                        <p class="text-xs text-gray-500">{{ admin_users|length }} admin(s)</p>
                    </div>
                </div>
            </div>

            <!-- 12. Mises Ã  jour GitHub -->
            <div class="bg-green-50 border-2 border-dashed border-green-400 rounded-lg p-4 hover:shadow-lg transition-all">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-2xl">ğŸ”„</span>
                    <h3 class="text-base font-bold text-gray-800">Mises Ã  jour</h3>
                </div>
                <p class="text-xs text-gray-600 mb-3">Mise Ã  jour depuis GitHub</p>
                
                {% if git_info.git_available %}
                <div class="space-y-2">
                    <div class="bg-white p-2 rounded border">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-bold">Ã‰tat</span>
                            {% if git_info.has_updates %}
                            <span class="px-1 py-0.5 rounded text-xs bg-orange-100 text-orange-700">
                                âš ï¸ {{ git_info.update_count }} MAJ
                            </span>
                            {% else %}
                            <span class="px-1 py-0.5 rounded text-xs bg-green-100 text-green-700">
                                âœ… Ã€ jour
                            </span>
                            {% endif %}
                        </div>
                        <p class="text-xs text-gray-500 font-mono">{{ git_info.current_branch }}</p>
                    </div>
                    
                    <form method="POST" action="{{ url_for('admin.perform_update') }}" 
                          onsubmit="return confirm('âš ï¸ Mettre Ã  jour l\'application ?');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" 
                                {% if not git_info.has_updates %}disabled{% endif %}
                                class="w-full px-3 py-1.5 {% if git_info.has_updates %}bg-white text-green-600 border-2 border-green-600 hover:bg-green-50{% else %}bg-gray-100 text-gray-400 border-2 border-gray-300 cursor-not-allowed{% endif %} font-bold rounded transition-all text-xs">
                            ğŸš€ Mettre Ã  jour
                        </button>
                    </form>
                    
                    <button onclick="checkForUpdates()" 
                            class="w-full px-3 py-1.5 bg-white text-blue-600 font-bold rounded border-2 border-blue-600 hover:bg-blue-50 transition-all text-xs">
                        ğŸ” VÃ©rifier les MAJ
                    </button>
                </div>
                
                <script>
                    function checkForUpdates() {
                        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '{{ csrf_token() }}';
                        
                        fetch('{{ url_for("admin.check_updates") }}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('âœ… VÃ©rification terminÃ©e. Rechargement...');
                                location.reload();
                            } else {
                                alert('âŒ Erreur: ' + (data.message || 'Impossible de vÃ©rifier'));
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('âŒ Erreur lors de la vÃ©rification');
                        });
                    }
                </script>
                {% else %}
                <div class="bg-white p-2 rounded border">
                    <p class="text-orange-600 text-xs">âš ï¸ Git non disponible</p>
                </div>
                {% endif %}
            </div>

        </div>
    </div>
</div>
{% endblock %}

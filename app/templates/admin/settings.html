{% extends "base.html" %}

{% block title %}Paramètres - Administration - Talento{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8 px-4">
    <div class="max-w-6xl mx-auto">
        
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">⚙️ Paramètres</h1>
            <p class="text-gray-600">Configuration de l'application et gestion des administrateurs</p>
        </div>

        <!-- Messages Flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="mb-6 p-4 rounded-lg border-2 {% if category == 'success' %}bg-green-50 border-green-300 text-green-800{% elif category == 'error' %}bg-red-50 border-red-300 text-red-800{% else %}bg-blue-50 border-blue-300 text-blue-800{% endif %}">
                    {{ message }}
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Configuration API Keys -->
        <div class="section-blue p-8 mb-8">
            <div class="flex items-center gap-3 mb-6">
                <span class="text-4xl">🔑</span>
                <h2 class="text-2xl font-bold text-gray-800">Clés API et Configuration</h2>
            </div>
            
            <form method="POST" action="{{ url_for('admin.save_settings') }}" class="space-y-6">
                <!-- SendGrid Configuration -->
                <div class="bg-white p-6 rounded-lg border-2 {% if config.sendgrid %}border-green-300{% else %}border-orange-300{% endif %}">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">📧</span>
                            <h3 class="text-lg font-bold text-gray-800">SendGrid API Key</h3>
                        </div>
                        <span class="px-3 py-1 rounded-full text-sm font-semibold {% if config.sendgrid %}bg-green-100 text-green-700{% else %}bg-orange-100 text-orange-700{% endif %}">
                            {% if config.sendgrid %}✅ Configuré{% else %}⚠️ Non configuré{% endif %}
                        </span>
                    </div>
                    <p class="text-gray-600 text-sm mb-4">Clé API pour l'envoi automatique des emails (confirmation, identifiants)</p>
                    <input type="password" 
                           name="sendgrid_api_key" 
                           value="{{ config.sendgrid_key_masked }}" 
                           placeholder="SG.xxxxxxxxxxxxxxxxxxxxxxxxx"
                           class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm">
                    <p class="text-xs text-gray-500 mt-2">💡 Obtenez votre clé sur <a href="https://sendgrid.com" target="_blank" class="text-blue-600 hover:underline">sendgrid.com</a></p>
                </div>

                <!-- OpenRouter Configuration -->
                <div class="bg-white p-6 rounded-lg border-2 {% if config.openrouter %}border-green-300{% else %}border-orange-300{% endif %}">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">🤖</span>
                            <h3 class="text-lg font-bold text-gray-800">OpenRouter API Key</h3>
                        </div>
                        <span class="px-3 py-1 rounded-full text-sm font-semibold {% if config.openrouter %}bg-green-100 text-green-700{% else %}bg-orange-100 text-orange-700{% endif %}">
                            {% if config.openrouter %}✅ Configuré{% else %}⚠️ Non configuré{% endif %}
                        </span>
                    </div>
                    <p class="text-gray-600 text-sm mb-4">Clé API pour l'analyse intelligente des CV par IA</p>
                    <input type="password" 
                           name="openrouter_api_key" 
                           value="{{ config.openrouter_key_masked }}" 
                           placeholder="sk-or-v1-xxxxxxxxxxxxxxxxxxxxxxxx"
                           class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm">
                    <p class="text-xs text-gray-500 mt-2">💡 Obtenez votre clé sur <a href="https://openrouter.ai" target="_blank" class="text-blue-600 hover:underline">openrouter.ai</a></p>
                </div>

                <!-- Email Configuration -->
                <div class="bg-white p-6 rounded-lg border-2 border-blue-300">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-3xl">✉️</span>
                        <h3 class="text-lg font-bold text-gray-800">Email Expéditeur</h3>
                    </div>
                    <p class="text-gray-600 text-sm mb-4">Adresse email qui apparaîtra comme expéditeur des emails automatiques</p>
                    <input type="email" 
                           name="sender_email" 
                           value="{{ config.sendgrid_from }}" 
                           placeholder="noreply@myoneart.com"
                           class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- Save Button -->
                <div class="flex justify-end">
                    <button type="submit" class="px-8 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-all flex items-center gap-2">
                        <span>💾</span>
                        <span>Enregistrer les paramètres</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Email Test Section -->
        <div class="section-green p-8 mb-8">
            <div class="flex items-center gap-3 mb-6">
                <span class="text-4xl">📮</span>
                <h2 class="text-2xl font-bold text-gray-800">Test d'envoi d'email</h2>
            </div>
            
            <p class="text-gray-600 mb-4">Testez la configuration SendGrid en envoyant un email de test</p>
            
            <form method="POST" action="{{ url_for('admin.test_email') }}" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Email destinataire</label>
                    <input type="email" 
                           name="test_email" 
                           placeholder="votre.email@exemple.com"
                           required
                           class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <button type="submit" 
                        {% if not config.sendgrid %}disabled{% endif %}
                        class="px-6 py-3 {% if config.sendgrid %}bg-green-600 hover:bg-green-700{% else %}bg-gray-400 cursor-not-allowed{% endif %} text-white font-bold rounded-lg transition-all flex items-center gap-2">
                    <span>📧</span>
                    <span>Envoyer un email de test</span>
                </button>
                {% if not config.sendgrid %}
                <p class="text-sm text-orange-600">⚠️ Configurez d'abord la clé SendGrid API ci-dessus pour activer cette fonctionnalité</p>
                {% endif %}
            </form>
        </div>

        <!-- Administrateurs -->
        <div class="section-purple p-8 mb-8">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <span class="text-4xl">👥</span>
                    <h2 class="text-2xl font-bold text-gray-800">Utilisateurs Administrateurs</h2>
                </div>
                <a href="{{ url_for('admin.create_admin_user') }}" 
                   class="px-6 py-3 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition-all flex items-center gap-2">
                    <span>➕</span>
                    <span>Créer un nouvel admin</span>
                </a>
            </div>
            
            <div class="bg-white rounded-lg border-2 border-purple-300 overflow-hidden">
                <table class="min-w-full divide-y divide-purple-200">
                    <thead class="bg-purple-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Nom complet</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Email</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Code unique</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Date de création</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-purple-100">
                        {% for admin in admin_users %}
                        <tr class="hover:bg-purple-50 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    {% if admin.photo_filename %}
                                    <img src="{{ url_for('static', filename='uploads/photos/' + admin.photo_filename) }}" 
                                         alt="{{ admin.full_name }}" 
                                         class="w-10 h-10 rounded-full mr-3 object-cover border-2 border-purple-300">
                                    {% else %}
                                    <div class="w-10 h-10 rounded-full mr-3 bg-gradient-to-br from-purple-400 to-purple-600 flex items-center justify-center text-white text-sm font-bold border-2 border-purple-300">
                                        {{ admin.first_name[0] if admin.first_name else '?' }}{{ admin.last_name[0] if admin.last_name else '?' }}
                                    </div>
                                    {% endif %}
                                    <div>
                                        <div class="text-sm font-medium text-gray-900">{{ admin.full_name }}</div>
                                        {% if admin.id == current_user.id %}
                                        <div class="text-xs text-purple-600 font-semibold">Vous</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ admin.email }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-600">{{ admin.formatted_code }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">{{ admin.created_at.strftime('%d/%m/%Y') }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                {% if admin.id != current_user.id and admin_users|length > 1 %}
                                <form method="POST" action="{{ url_for('admin.demote_admin', user_id=admin.id) }}" 
                                      onsubmit="return confirm('Êtes-vous sûr de vouloir retirer les droits administrateur à {{ admin.full_name }} ?');" 
                                      class="inline">
                                    <button type="submit" class="px-3 py-1 bg-red-100 text-red-700 rounded border border-red-300 hover:bg-red-200 transition-all text-xs font-semibold">
                                        Retirer admin
                                    </button>
                                </form>
                                {% else %}
                                <span class="text-xs text-gray-400 italic">Actions indisponibles</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Promote existing user -->
            <div class="mt-6 bg-purple-50 p-6 rounded-lg border-2 border-purple-300">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <span>⬆️</span>
                    <span>Promouvoir un utilisateur existant en administrateur</span>
                </h3>
                <p class="text-sm text-gray-600 mb-4">Sélectionnez un utilisateur existant dans la liste pour lui donner les droits administrateur.</p>
                
                <form method="POST" action="#" id="promote-form" onsubmit="return confirmPromotion();">
                    <div class="flex gap-3">
                        <select name="user_id" id="user-select" class="flex-1 px-4 py-2 border-2 border-purple-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                            <option value="">-- Sélectionnez un utilisateur --</option>
                        </select>
                        <button type="button" onclick="loadNonAdminUsers()" class="px-4 py-2 bg-blue-100 text-blue-700 font-semibold rounded-lg border-2 border-blue-300 hover:bg-blue-200 transition-all">
                            📋 Charger les utilisateurs
                        </button>
                        <button type="submit" class="px-6 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition-all">
                            ✨ Promouvoir
                        </button>
                    </div>
                </form>

                <script>
                    function loadNonAdminUsers() {
                        fetch('/admin/users')
                            .then(response => response.text())
                            .then(html => {
                                const parser = new DOMParser();
                                const doc = parser.parseFromString(html, 'text/html');
                                const select = document.getElementById('user-select');
                                select.innerHTML = '<option value="">-- Sélectionnez un utilisateur --</option>';
                                
                                const rows = doc.querySelectorAll('tbody tr');
                                rows.forEach(row => {
                                    const cells = row.querySelectorAll('td');
                                    if (cells.length >= 3) {
                                        const code = cells[0].textContent.trim();
                                        const name = cells[1].textContent.trim();
                                        const userId = row.querySelector('a[href*="edit"]')?.href.match(/\/(\d+)\/edit/)?.[1];
                                        
                                        if (userId) {
                                            const option = document.createElement('option');
                                            option.value = userId;
                                            option.textContent = `${name} (${code})`;
                                            select.appendChild(option);
                                        }
                                    }
                                });
                                
                                if (select.options.length === 1) {
                                    alert('Aucun utilisateur non-admin trouvé');
                                }
                            })
                            .catch(error => {
                                console.error('Erreur:', error);
                                alert('Impossible de charger les utilisateurs');
                            });
                    }

                    function confirmPromotion() {
                        const select = document.getElementById('user-select');
                        const selectedOption = select.options[select.selectedIndex];
                        
                        if (!select.value) {
                            alert('Veuillez sélectionner un utilisateur');
                            return false;
                        }
                        
                        const confirmed = confirm(`Êtes-vous sûr de vouloir promouvoir ${selectedOption.text} en administrateur ?`);
                        if (confirmed) {
                            document.getElementById('promote-form').action = `/admin/user/${select.value}/promote-admin`;
                            return true;
                        }
                        return false;
                    }
                </script>
            </div>
        </div>

        <!-- GitHub Update Section -->
        <div class="section-cyan p-8 mb-8">
            <div class="flex items-center gap-3 mb-6">
                <span class="text-4xl">🔄</span>
                <h2 class="text-2xl font-bold text-gray-800">Mise à jour depuis GitHub</h2>
            </div>
            
            {% if git_info.git_available %}
                <!-- Git Status -->
                <div class="bg-white p-6 rounded-lg border-2 border-cyan-300 mb-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <span>📦</span>
                            <span>État du repository</span>
                        </h3>
                        {% if git_info.has_updates %}
                        <span class="px-3 py-1 rounded-full text-sm font-semibold bg-orange-100 text-orange-700">
                            ⚠️ {{ git_info.update_count }} mise(s) à jour disponible(s)
                        </span>
                        {% else %}
                        <span class="px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-700">
                            ✅ À jour
                        </span>
                        {% endif %}
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <p class="text-sm text-gray-600">Branche actuelle</p>
                            <p class="font-mono text-sm font-semibold text-gray-800">{{ git_info.current_branch }}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Commit actuel</p>
                            <p class="font-mono text-sm font-semibold text-gray-800">{{ git_info.current_commit }}</p>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-sm text-gray-600 mb-1">Repository distant</p>
                        <p class="font-mono text-xs text-gray-700 break-all bg-gray-50 p-2 rounded">{{ git_info.remote_url }}</p>
                    </div>
                    
                    <div class="flex gap-3">
                        <form method="POST" action="{{ url_for('admin.perform_update') }}" class="inline" 
                              onsubmit="return confirm('⚠️ Cette action va mettre à jour l\'application depuis GitHub, installer les dépendances et exécuter les migrations. L\'application redémarrera. Continuer ?');">
                            <button type="submit" 
                                    {% if not git_info.has_updates %}disabled{% endif %}
                                    class="px-6 py-3 {% if git_info.has_updates %}bg-cyan-600 hover:bg-cyan-700{% else %}bg-gray-400 cursor-not-allowed{% endif %} text-white font-bold rounded-lg transition-all flex items-center gap-2">
                                <span>🚀</span>
                                <span>Mettre à jour maintenant</span>
                            </button>
                        </form>
                        <button onclick="checkForUpdates()" 
                                class="px-6 py-3 bg-blue-100 text-blue-700 font-bold rounded-lg border-2 border-blue-400 hover:bg-blue-200 transition-all flex items-center gap-2">
                            <span>🔍</span>
                            <span>Vérifier les mises à jour</span>
                        </button>
                    </div>
                </div>

                <!-- Recent Commits -->
                {% if git_info.recent_commits %}
                <div class="bg-white p-6 rounded-lg border-2 border-cyan-300 mb-4">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <span>📝</span>
                        <span>Commits récents</span>
                    </h3>
                    <div class="space-y-2">
                        {% for commit in git_info.recent_commits %}
                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-gray-800">{{ commit.message }}</p>
                                    <p class="text-xs text-gray-600 mt-1">
                                        <span class="font-mono">{{ commit.hash }}</span> • 
                                        {{ commit.author }} • 
                                        {{ commit.date }}
                                    </p>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Update History -->
                {% if update_history %}
                <div class="bg-white p-6 rounded-lg border-2 border-cyan-300">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <span>📜</span>
                        <span>Historique des mises à jour</span>
                    </h3>
                    <div class="space-y-2">
                        {% for update in update_history|reverse %}
                        <div class="bg-gray-50 p-3 rounded-lg border {% if update.success %}border-green-200{% else %}border-red-200{% endif %}">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs font-mono text-gray-600">{{ update.timestamp[:19] }}</span>
                                <span class="px-2 py-1 rounded text-xs font-semibold {% if update.success %}bg-green-100 text-green-700{% else %}bg-red-100 text-red-700{% endif %}">
                                    {% if update.success %}✅ Succès{% else %}❌ Échec{% endif %}
                                </span>
                            </div>
                            <div class="text-xs text-gray-700">
                                {% for step in update.steps %}
                                <span class="{% if step.success %}text-green-600{% else %}text-red-600{% endif %}">
                                    {{ step.name }}{% if not loop.last %} → {% endif %}
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <script>
                    function checkForUpdates() {
                        fetch('{{ url_for("admin.check_updates") }}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                alert('Erreur: ' + data.error);
                            } else {
                                if (data.has_updates) {
                                    alert(`✅ ${data.count} mise(s) à jour disponible(s)! Rechargez la page pour voir les détails.`);
                                    location.reload();
                                } else {
                                    alert('✅ Aucune mise à jour disponible. Vous êtes à jour!');
                                }
                            }
                        })
                        .catch(error => {
                            alert('Erreur lors de la vérification: ' + error);
                        });
                    }
                </script>
            {% else %}
                <div class="bg-orange-50 p-6 rounded-lg border-2 border-orange-300">
                    <p class="text-orange-800 font-semibold mb-2">⚠️ Git n'est pas disponible sur ce système</p>
                    <p class="text-sm text-orange-700">La fonctionnalité de mise à jour automatique depuis GitHub nécessite Git.</p>
                </div>
            {% endif %}
        </div>

        <!-- Backup & Restore Section -->
        <div class="section-orange p-8 mb-8">
            <div class="flex items-center gap-3 mb-6">
                <span class="text-4xl">💾</span>
                <h2 class="text-2xl font-bold text-gray-800">Sauvegarde & Restauration</h2>
            </div>
            
            <div class="bg-white p-6 rounded-lg border-2 border-orange-300">
                <div class="flex items-center gap-3 mb-4">
                    <span class="text-3xl">📦</span>
                    <h3 class="text-lg font-bold text-gray-800">Exporter les données</h3>
                </div>
                <p class="text-gray-600 text-sm mb-4">
                    Téléchargez une copie complète de tous les profils utilisateurs pour créer une sauvegarde de vos données. Utilisez ces exports pour archiver vos données ou les analyser hors ligne.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                    <a href="{{ url_for('admin.export_excel') }}" 
                       class="px-6 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition-all text-center flex items-center justify-center gap-2">
                        <span>📊</span>
                        <span>Excel</span>
                    </a>
                    <a href="{{ url_for('admin.export_csv') }}" 
                       class="px-6 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-all text-center flex items-center justify-center gap-2">
                        <span>📄</span>
                        <span>CSV</span>
                    </a>
                    <a href="{{ url_for('admin.export_pdf') }}" 
                       class="px-6 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-all text-center flex items-center justify-center gap-2">
                        <span>📑</span>
                        <span>PDF</span>
                    </a>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <p class="text-blue-800 font-semibold mb-2">💡 Conseil de sauvegarde</p>
                    <p class="text-sm text-blue-700">
                        Il est recommandé de télécharger vos données au format Excel ou CSV régulièrement (hebdomadaire ou mensuelle) pour protéger vos informations. Ces fichiers peuvent être ouverts dans Excel, Google Sheets ou tout autre tableur.
                    </p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg border-2 border-orange-300 mt-6">
                <div class="flex items-center gap-3 mb-4">
                    <span class="text-3xl">⬆️</span>
                    <h3 class="text-lg font-bold text-gray-800">Importer des données</h3>
                </div>
                <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                    <p class="text-orange-800 font-semibold mb-2">⚠️ Fonctionnalité en développement</p>
                    <p class="text-sm text-orange-700 mb-3">
                        L'importation automatique de données depuis Excel ou CSV sera disponible dans une future mise à jour.
                    </p>
                    <p class="text-sm text-orange-700">
                        Pour importer des données actuellement : utilisez le formulaire d'inscription pour ajouter de nouveaux profils, ou contactez un administrateur système pour une importation en masse via la base de données.
                    </p>
                </div>
            </div>

            <!-- Sauvegarde Complète -->
            <div class="bg-white p-6 rounded-lg border-2 border-green-300 mt-6">
                <div class="flex items-center gap-3 mb-4">
                    <span class="text-3xl">💾</span>
                    <h3 class="text-lg font-bold text-gray-800">Sauvegarde Complète de l'Application</h3>
                </div>
                <p class="text-gray-600 text-sm mb-4">
                    Créez une sauvegarde complète incluant tous les profils (avec données décryptées), fichiers uploadés, configuration et base de données. Cette sauvegarde peut être utilisée pour restaurer l'application sur une nouvelle instance.
                </p>
                <form method="POST" action="{{ url_for('admin.create_backup') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" 
                            class="inline-flex items-center gap-2 px-6 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition-all shadow-md hover:shadow-lg">
                        <span>📦</span>
                        <span>Créer une sauvegarde complète (ZIP)</span>
                    </button>
                </form>
                <div class="bg-green-50 p-4 rounded-lg border border-green-200 mt-4">
                    <p class="text-green-800 font-semibold mb-2">ℹ️ Contenu de la sauvegarde</p>
                    <ul class="text-sm text-green-700 space-y-1">
                        <li>✅ Tous les profils utilisateurs (données décryptées)</li>
                        <li>✅ Fichiers uploadés (photos, CVs, QR codes)</li>
                        <li>✅ Configuration de l'application</li>
                        <li>✅ Base de données complète</li>
                    </ul>
                </div>
            </div>

            <!-- Restauration Complète -->
            <div class="bg-white p-6 rounded-lg border-2 border-red-300 mt-6">
                <div class="flex items-center gap-3 mb-4">
                    <span class="text-3xl">⚠️</span>
                    <h3 class="text-lg font-bold text-gray-800">Restauration Complète</h3>
                </div>
                <p class="text-gray-600 text-sm mb-4">
                    Restaurez l'application depuis un fichier de sauvegarde ZIP. <strong class="text-red-600">Attention : Cette action remplacera TOUTES les données actuelles !</strong>
                </p>
                <form method="POST" action="{{ url_for('admin.restore_backup') }}" enctype="multipart/form-data"
                      onsubmit="return confirm('⚠️ ATTENTION ⚠️\n\nCette action va REMPLACER toutes les données actuelles par celles du fichier de sauvegarde.\n\n✅ Tous les utilisateurs actuels seront supprimés\n✅ Tous les fichiers actuels seront remplacés\n✅ Toute la configuration actuelle sera remplacée\n\nÊtes-vous ABSOLUMENT SÛR de vouloir continuer ?');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Fichier de sauvegarde (ZIP)
                            </label>
                            <div class="relative">
                                <input type="file" 
                                       name="backup_file" 
                                       accept=".zip"
                                       required
                                       id="backup_file_input"
                                       class="block w-full text-sm text-gray-700 file:mr-4 file:py-3 file:px-6 file:rounded-lg file:border-0 file:text-sm file:font-bold file:bg-red-100 file:text-red-700 hover:file:bg-red-200 file:cursor-pointer border-2 border-gray-300 rounded-lg cursor-pointer bg-white hover:bg-gray-50 transition-all focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500">
                            </div>
                        </div>
                        <button type="submit" 
                                class="inline-flex items-center gap-2 px-6 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-all shadow-md hover:shadow-lg">
                            <span>⚠️</span>
                            <span>Restaurer depuis la sauvegarde</span>
                        </button>
                    </div>
                </form>
                <div class="bg-red-50 p-4 rounded-lg border border-red-200 mt-4">
                    <p class="text-red-800 font-semibold mb-2">⚠️ Avertissement important</p>
                    <p class="text-sm text-red-700">
                        La restauration est une opération irréversible. Assurez-vous d'avoir créé une sauvegarde de vos données actuelles avant de procéder à une restauration.
                    </p>
                </div>
            </div>
        </div>

        <!-- Database Info -->
        <div class="section-gray p-8 mb-8">
            <div class="flex items-center gap-3 mb-6">
                <span class="text-4xl">💾</span>
                <h2 class="text-2xl font-bold text-gray-800">Base de données</h2>
            </div>
            
            <!-- Connection Status -->
            <div class="bg-white p-6 rounded-lg border-2 {% if db_diagnostics.connection_status %}border-green-300{% else %}border-red-300{% endif %} mb-4 hover:shadow-lg transition-all">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                        <span>🔌</span>
                        <span>État de la connexion</span>
                    </h3>
                    <span class="px-3 py-1 rounded-full text-sm font-semibold {% if db_diagnostics.connection_status %}bg-green-100 text-green-700{% else %}bg-red-100 text-red-700{% endif %}">
                        {% if db_diagnostics.connection_status %}✅ Connecté{% else %}❌ Déconnecté{% endif %}
                    </span>
                </div>
                <div class="space-y-2 text-sm">
                    <p class="text-gray-700"><strong>Type :</strong> {{ db_diagnostics.connection.type }}</p>
                    <p class="text-gray-700 font-mono text-xs break-all"><strong>URI :</strong> {{ db_diagnostics.connection.uri_masked }}</p>
                </div>
            </div>

            <!-- Database Statistics -->
            <div class="bg-white p-6 rounded-lg border-2 border-blue-300 mb-4 hover:shadow-lg transition-all">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <span>📊</span>
                    <span>Statistiques</span>
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <p class="text-xs text-gray-600 mb-1">Utilisateurs</p>
                        <p class="text-2xl font-bold text-blue-600">{{ db_diagnostics.table_stats.users }}</p>
                        <p class="text-xs text-gray-500 mt-1">{{ db_diagnostics.table_stats.users_active }} actifs</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <p class="text-xs text-gray-600 mb-1">Administrateurs</p>
                        <p class="text-2xl font-bold text-purple-600">{{ db_diagnostics.table_stats.users_admin }}</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <p class="text-xs text-gray-600 mb-1">Talents</p>
                        <p class="text-2xl font-bold text-green-600">{{ db_diagnostics.table_stats.talents }}</p>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                        <p class="text-xs text-gray-600 mb-1">Pays / Villes</p>
                        <p class="text-2xl font-bold text-orange-600">{{ db_diagnostics.table_stats.countries }} / {{ db_diagnostics.table_stats.cities }}</p>
                    </div>
                </div>
                
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-sm text-gray-700"><strong>Taille de la base :</strong> {{ db_diagnostics.size }}</p>
                            <p class="text-sm text-gray-700"><strong>Dernière migration :</strong> <span class="font-mono">{{ db_diagnostics.last_migration }}</span></p>
                        </div>
                        <div class="text-xs text-gray-500">
                            <p>{{ db_diagnostics.table_stats.user_talents }} associations talents</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tables List -->
            <div class="bg-white p-6 rounded-lg border-2 border-gray-300 hover:shadow-lg transition-all">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <span>📋</span>
                    <span>Tables ({{ db_diagnostics.tables|length }})</span>
                </h3>
                <div class="flex flex-wrap gap-2">
                    {% for table in db_diagnostics.tables %}
                    <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-lg text-sm font-mono border border-gray-300">{{ table }}</span>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Bouton Retour -->
        <div class="mb-6">
            <a href="{{ url_for('main.index') }}" 
               class="px-6 py-3 bg-gray-100 text-gray-700 font-bold rounded-lg border-2 border-gray-500 hover:bg-gray-200 transition-all inline-flex items-center gap-2">
                <span>◀️</span>
                <span>Retour au Dashboard</span>
            </a>
        </div>

    </div>
</div>
{% endblock %}

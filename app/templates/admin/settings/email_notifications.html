{% extends "base.html" %}

{% block title %}Notifications Email - Param√®tres{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8 px-4">
    <div class="max-w-7xl mx-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">üìß Gestion des Notifications Email</h1>
                <p class="text-gray-600 mt-2">Consultez les emails envoy√©s par le syst√®me et g√©rez les notifications</p>
            </div>
            <a href="{{ url_for('admin.settings') }}" class="bg-white border-2 border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 font-semibold">
                ‚Üê Retour aux param√®tres
            </a>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="mb-4 p-4 rounded-lg border-2 {% if category == 'success' %}bg-green-50 border-green-300 text-green-800{% elif category == 'error' %}bg-red-50 border-red-300 text-red-800{% else %}bg-blue-50 border-blue-300 text-blue-800{% endif %}">
                    {{ message }}
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

<!-- Statistiques -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-blue-50 p-4 rounded-lg border-2 border-blue-200">
        <p class="text-sm font-semibold text-gray-600">Total Envoy√©s</p>
        <p class="text-2xl font-bold text-gray-800">{{ stats.total }}</p>
    </div>
    <div class="bg-green-50 p-4 rounded-lg border-2 border-green-200">
        <p class="text-sm font-semibold text-gray-600">Succ√®s</p>
        <p class="text-2xl font-bold text-green-700">{{ stats.sent }}</p>
    </div>
    <div class="bg-red-50 p-4 rounded-lg border-2 border-red-200">
        <p class="text-sm font-semibold text-gray-600">√âchecs</p>
        <p class="text-2xl font-bold text-red-700">{{ stats.failed }}</p>
    </div>
    <div class="bg-purple-50 p-4 rounded-lg border-2 border-purple-200">
        <p class="text-sm font-semibold text-gray-600">Taux de Succ√®s</p>
        <p class="text-2xl font-bold text-purple-700">{{ stats.success_rate }}%</p>
    </div>
</div>

<!-- Configuration des Templates -->
<div class="bg-white rounded-lg shadow-md p-6 border-2 border-gray-200 mb-6">
    <div class="flex items-center justify-between mb-4">
        <div>
            <h3 class="text-xl font-bold text-gray-800">‚öôÔ∏è Configuration des Templates Email</h3>
            <p class="text-gray-600 mt-1">Activez ou d√©sactivez l'envoi automatique de chaque type d'email</p>
        </div>
    </div>
    
    <div class="space-y-3">
        {% for template_id, template_info in available_templates.items() %}
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex-1">
                <p class="font-semibold text-gray-800">{{ template_info.name }}</p>
                <p class="text-sm text-gray-600">{{ template_info.description }}</p>
            </div>
            <div class="flex gap-2">
                <a href="{{ url_for('admin.view_email_template', template_type=template_id) }}" 
                   target="_blank"
                   class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg font-bold border-2 border-blue-500 hover:bg-blue-200 transition-all">
                    üëÅÔ∏è Voir le Template
                </a>
                <form method="POST" action="{{ url_for('admin.toggle_email_notification', template_type=template_id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="px-4 py-2 rounded-lg font-bold border-2 transition-all {% if template_info.enabled %}bg-green-100 text-green-700 border-green-500 hover:bg-green-200{% else %}bg-red-100 text-red-700 border-red-500 hover:bg-red-200{% endif %}">
                        {% if template_info.enabled %}
                        ‚úÖ Activ√©
                        {% else %}
                        ‚ùå D√©sactiv√©
                        {% endif %}
                    </button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Filtres -->
<div class="bg-white rounded-lg shadow-md p-6 border-2 border-gray-200 mb-6">
    <h3 class="text-xl font-bold text-gray-800 mb-4">üîç Filtrer les Emails</h3>
    <form method="GET" class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Type de Template</label>
            <select name="template" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none">
                <option value="">Tous les types</option>
                {% for template in template_types %}
                <option value="{{ template }}" {% if template == template_filter %}selected{% endif %}>{{ template }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Statut</label>
            <select name="status" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none">
                <option value="">Tous les statuts</option>
                <option value="sent" {% if status_filter == 'sent' %}selected{% endif %}>Envoy√©</option>
                <option value="failed" {% if status_filter == 'failed' %}selected{% endif %}>√âchou√©</option>
            </select>
        </div>
        <div class="flex items-end">
            <button type="submit" class="w-full bg-blue-100 text-blue-700 px-6 py-2 rounded-lg font-bold border-2 border-blue-500 hover:bg-blue-200 transition-all">
                Filtrer
            </button>
        </div>
    </form>
</div>

<!-- Liste des Emails -->
<div class="bg-white rounded-lg shadow-md p-6 border-2 border-gray-200">
    <h3 class="text-xl font-bold text-gray-800 mb-4">üìã Historique des Emails Envoy√©s</h3>
    
    {% if email_logs.items %}
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead>
                <tr class="bg-gray-100 border-b-2 border-gray-300">
                    <th class="px-4 py-3 text-left text-sm font-bold text-gray-700">Date</th>
                    <th class="px-4 py-3 text-left text-sm font-bold text-gray-700">Destinataire</th>
                    <th class="px-4 py-3 text-left text-sm font-bold text-gray-700">Sujet</th>
                    <th class="px-4 py-3 text-left text-sm font-bold text-gray-700">Type</th>
                    <th class="px-4 py-3 text-left text-sm font-bold text-gray-700">Statut</th>
                    <th class="px-4 py-3 text-left text-sm font-bold text-gray-700">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for log in email_logs.items %}
                <tr class="border-b border-gray-200 hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm text-gray-600">
                        {{ log.sent_at.strftime('%d/%m/%Y %H:%M') if log.sent_at else 'N/A' }}
                    </td>
                    <td class="px-4 py-3 text-sm">
                        <p class="font-semibold text-gray-800">{{ log.recipient_name or 'N/A' }}</p>
                        <p class="text-gray-600">{{ log.recipient_email }}</p>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-700">
                        {{ log.subject[:60] }}{% if log.subject|length > 60 %}...{% endif %}
                    </td>
                    <td class="px-4 py-3 text-sm">
                        <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-semibold">
                            {{ log.template_type }}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm">
                        {% if log.status == 'sent' %}
                        <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">‚úÖ Envoy√©</span>
                        {% else %}
                        <span class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold">‚ùå √âchou√©</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-sm">
                        <a href="{{ url_for('admin.view_email_log', log_id=log.id) }}" 
                           target="_blank"
                           class="text-blue-600 hover:text-blue-800 font-semibold">
                            üëÅÔ∏è Voir
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    {% if email_logs.pages > 1 %}
    <div class="mt-4 flex justify-center gap-2">
        {% if email_logs.has_prev %}
        <a href="{{ url_for('admin.settings_email_notifications', page=email_logs.prev_num, template=template_filter, status=status_filter) }}" 
           class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">
            ‚Üê Pr√©c√©dent
        </a>
        {% endif %}
        
        <span class="px-4 py-2 bg-blue-100 text-blue-700 rounded font-bold">
            Page {{ email_logs.page }} sur {{ email_logs.pages }}
        </span>
        
        {% if email_logs.has_next %}
        <a href="{{ url_for('admin.settings_email_notifications', page=email_logs.next_num, template=template_filter, status=status_filter) }}" 
           class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">
            Suivant ‚Üí
        </a>
        {% endif %}
    </div>
    {% endif %}
    
    {% else %}
    <p class="text-gray-600 text-center py-8">Aucun email envoy√© pour le moment</p>
    {% endif %}
</div>

    </div>
</div>
{% endblock %}

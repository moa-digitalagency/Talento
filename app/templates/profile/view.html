{% extends "base.html" %}

{% block title %}Profil de {{ user.full_name }} - Talento{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8 px-4">
    <div class="max-w-5xl mx-auto">
        
        <!-- Boutons d'action en haut -->
        {% if current_user.is_authenticated and current_user.is_admin %}
        <div class="mb-6 flex flex-col sm:flex-row gap-3 sm:justify-between">
            <a href="{{ url_for('main.talents') }}" 
               class="px-4 sm:px-6 py-2 sm:py-3 bg-gray-100 text-gray-700 font-bold rounded-lg border-2 border-gray-500 hover:bg-gray-200 transition-all flex items-center justify-center gap-2 text-sm sm:text-base">
                <span>◀️</span>
                <span>Retour</span>
            </a>
            <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
                <a href="{{ url_for('admin.edit_user', user_id=user.id) }}" 
                   class="px-4 sm:px-6 py-2 sm:py-3 bg-purple-100 text-purple-700 font-bold rounded-lg border-2 border-purple-500 hover:bg-purple-200 transition-all flex items-center justify-center gap-2 text-sm sm:text-base">
                    <span>✏️</span>
                    <span>Modifier</span>
                </a>
                <form method="POST" action="{{ url_for('admin.toggle_active', user_id=user.id) }}" class="w-full sm:w-auto">
                    <button type="submit" class="w-full sm:w-auto px-4 sm:px-6 py-2 sm:py-3 {% if user.account_active %}bg-orange-100 text-orange-700 border-orange-500{% else %}bg-green-100 text-green-700 border-green-500{% endif %} font-bold rounded-lg border-2 hover:{% if user.account_active %}bg-orange-200{% else %}bg-green-200{% endif %} transition-all flex items-center justify-center gap-2 text-sm sm:text-base">
                        <span>{% if user.account_active %}⏸️{% else %}▶️{% endif %}</span>
                        <span>{% if user.account_active %}Suspendre{% else %}Activer{% endif %}</span>
                    </button>
                </form>
                <form method="POST" action="{{ url_for('admin.delete_user', user_id=user.id) }}" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer ce profil ? Cette action est irréversible.');" class="w-full sm:w-auto">
                    <button type="submit" class="w-full sm:w-auto px-4 sm:px-6 py-2 sm:py-3 bg-red-100 text-red-700 font-bold rounded-lg border-2 border-red-500 hover:bg-red-200 transition-all flex items-center justify-center gap-2 text-sm sm:text-base">
                        <span>🗑️</span>
                        <span>Supprimer</span>
                    </button>
                </form>
                <a href="{{ url_for('admin.export_pdf_individual', user_id=user.id) }}" 
                   class="px-4 sm:px-6 py-2 sm:py-3 bg-blue-100 text-blue-700 font-bold rounded-lg border-2 border-blue-500 hover:bg-blue-200 transition-all flex items-center justify-center gap-2 text-sm sm:text-base">
                    <span>📑</span>
                    <span class="hidden sm:inline">Télécharger PDF</span>
                    <span class="sm:hidden">PDF</span>
                </a>
            </div>
        </div>
        {% endif %}

        <!-- Carte principale du profil -->
        <div class="section-blue p-8 mb-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <!-- Colonne gauche: Photo et QR Code -->
                <div class="lg:col-span-1">
                    <div class="text-center">
                        <!-- Photo de profil -->
                        {% if user.photo_filename %}
                        <img src="{{ url_for('static', filename='uploads/photos/' + user.photo_filename) }}" 
                             alt="{{ user.full_name }}" 
                             class="w-48 h-48 rounded-full mx-auto mb-6 object-cover border-4 border-blue-500 shadow-xl">
                        {% else %}
                        <div class="w-48 h-48 rounded-full mx-auto mb-6 bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white text-6xl font-bold border-4 border-blue-500 shadow-xl">
                            {{ user.first_name[0] if user.first_name else '?' }}{{ user.last_name[0] if user.last_name else '?' }}
                        </div>
                        {% endif %}
                        
                        <!-- QR Code -->
                        {% if user.qr_code_filename %}
                        <div class="bg-white p-4 rounded-xl border-2 border-blue-300 inline-block hidden lg:block">
                            <img src="{{ url_for('static', filename='uploads/qrcodes/' + user.qr_code_filename) }}" 
                                 alt="QR Code" 
                                 class="w-40 h-40 mx-auto">
                            <p class="text-xs text-gray-600 mt-2">Scannez pour voir le profil</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Colonne droite: Informations principales -->
                <div class="lg:col-span-2">
                    <h1 class="text-4xl font-bold text-gray-800 mb-2">{{ user.full_name }}</h1>
                    <p class="text-xl text-blue-600 font-mono font-bold mb-4">{{ user.formatted_code }}</p>
                    
                    {% if user.bio %}
                    <div class="bg-blue-50 p-4 rounded-lg mb-6">
                        <p class="text-gray-700 leading-relaxed">{{ user.bio }}</p>
                    </div>
                    {% endif %}
                    
                    <!-- Informations clés -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        {% if user.years_experience %}
                        <div class="bg-white p-4 rounded-lg border-2 border-blue-200">
                            <p class="text-sm text-gray-600">Expérience</p>
                            <p class="text-2xl font-bold text-blue-600">{{ user.years_experience }} ans</p>
                        </div>
                        {% endif %}
                        
                        {% if user.availability %}
                        <div class="bg-white p-4 rounded-lg border-2 border-blue-200">
                            <p class="text-sm text-gray-600">Disponibilité</p>
                            <p class="text-lg font-bold {% if user.availability == 'Temps plein' %}text-green-600{% elif user.availability in ['Temps partiel', 'Mi-temps'] %}text-yellow-600{% elif user.availability == 'Flexible' %}text-blue-600{% else %}text-purple-600{% endif %}">
                                {% if user.availability == 'Temps plein' %}⏰ Temps plein
                                {% elif user.availability == 'Temps partiel' %}🕐 Temps partiel
                                {% elif user.availability == 'Mi-temps' %}⏳ Mi-temps
                                {% elif user.availability == 'Flexible' %}🔄 Flexible
                                {% elif user.availability == 'Occasionnel' %}📅 Occasionnel
                                {% else %}{{ user.availability }}{% endif %}
                            </p>
                        </div>
                        {% endif %}
                        
                        {% if user.work_mode %}
                        <div class="bg-white p-4 rounded-lg border-2 border-blue-200">
                            <p class="text-sm text-gray-600">Mode de travail</p>
                            <p class="text-lg font-bold text-gray-800">
                                {% if user.work_mode == 'remote' %}🏠 Télétravail
                                {% elif user.work_mode == 'on_site' %}🏢 Sur site
                                {% else %}🔄 Hybride{% endif %}
                            </p>
                        </div>
                        {% endif %}
                        
                        {% if user.rate_range %}
                        <div class="bg-white p-4 rounded-lg border-2 border-blue-200">
                            <p class="text-sm text-gray-600">Tarifs</p>
                            <p class="text-lg font-bold text-green-600">{{ user.rate_range }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Score et Analyse CV -->
        <div class="section-yellow p-8 mb-8">
            <div class="flex items-center gap-3 mb-6">
                <span class="text-4xl">🎯</span>
                <h2 class="text-2xl font-bold text-gray-800">Analyse du Profil</h2>
            </div>
            
            {% if not user.cv_filename %}
            <!-- Aucun CV uploadé -->
            <div class="bg-orange-50 p-8 rounded-lg border-2 border-orange-300 text-center">
                <div class="text-6xl mb-4">📄</div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Aucun CV disponible</h3>
                <p class="text-gray-600 mb-4">Ce profil n'a pas encore de CV uploadé. L'analyse intelligente sera disponible après l'ajout d'un CV.</p>
                {% if current_user.is_authenticated and (current_user.id == user.id or current_user.is_admin) %}
                <a href="{% if current_user.is_admin %}{{ url_for('admin.edit_user', user_id=user.id) }}{% else %}{{ url_for('profile.edit') }}{% endif %}" 
                   class="inline-block px-6 py-3 bg-orange-600 text-white font-bold rounded-lg hover:bg-orange-700 transition-all">
                    📎 Ajouter un CV
                </a>
                {% endif %}
            </div>
            {% elif user.profile_score or cv_analysis %}
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                {% if user.profile_score %}
                <div class="bg-white p-6 rounded-lg border-2 border-yellow-300 text-center">
                    <p class="text-sm text-gray-600 mb-2">Score du Profil</p>
                    <div class="relative w-32 h-32 mx-auto">
                        <svg class="transform -rotate-90 w-32 h-32">
                            <circle cx="64" cy="64" r="56" stroke="#fef3c7" stroke-width="8" fill="none"/>
                            <circle cx="64" cy="64" r="56" 
                                    stroke="{% if user.profile_score >= 70 %}#10b981{% elif user.profile_score >= 40 %}#f59e0b{% else %}#ef4444{% endif %}" 
                                    stroke-width="8" 
                                    fill="none" 
                                    stroke-dasharray="{{ (user.profile_score / 100 * 352)|round }}, 352"/>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-4xl font-bold {% if user.profile_score >= 70 %}text-green-600{% elif user.profile_score >= 40 %}text-yellow-600{% else %}text-red-600{% endif %}">
                                {{ user.profile_score }}
                            </span>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        {% if user.profile_score >= 70 %}✅ Excellent profil
                        {% elif user.profile_score >= 40 %}⚡ Profil prometteur
                        {% else %}📝 Profil à compléter{% endif %}
                    </p>
                </div>
                {% endif %}
                
                {% if cv_analysis and cv_analysis.get('experience_years') %}
                <div class="bg-white p-6 rounded-lg border-2 border-yellow-300 text-center">
                    <p class="text-sm text-gray-600 mb-2">Expérience Détectée</p>
                    <p class="text-5xl font-bold text-blue-600">{{ cv_analysis.experience_years }}</p>
                    <p class="text-lg text-gray-700 mt-2">ans</p>
                </div>
                {% endif %}
                
                {% if user.cv_analyzed_at %}
                <div class="bg-white p-6 rounded-lg border-2 border-yellow-300 text-center">
                    <p class="text-sm text-gray-600 mb-2">Dernière Analyse</p>
                    <p class="text-xl font-semibold text-gray-800">{{ user.cv_analyzed_at.strftime('%d/%m/%Y') }}</p>
                    <p class="text-sm text-gray-500 mt-1">{{ user.cv_analyzed_at.strftime('%H:%M') }}</p>
                </div>
                {% endif %}
            </div>
            
            {% if cv_analysis %}
            <div class="bg-yellow-50 p-6 rounded-lg border-2 border-yellow-300">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <span>🤖</span>
                    <span>Analyse par Intelligence Artificielle</span>
                </h3>
                
                {% if cv_analysis.get('strengths') %}
                <div class="mb-4">
                    <p class="font-semibold text-green-700 mb-2">✨ Points Forts :</p>
                    <ul class="list-disc list-inside space-y-1 text-gray-700">
                        {% for strength in cv_analysis.strengths %}
                        <li>{{ strength }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                {% if cv_analysis.get('skills_detected') %}
                <div class="mb-4">
                    <p class="font-semibold text-blue-700 mb-2">🔧 Compétences Détectées :</p>
                    <div class="flex flex-wrap gap-2">
                        {% for skill in cv_analysis.skills_detected %}
                        <span class="bg-blue-100 px-3 py-1 rounded-full text-sm font-medium text-blue-800 border border-blue-300">
                            {{ skill }}
                        </span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% if cv_analysis.get('recommendations') %}
                <div>
                    <p class="font-semibold text-purple-700 mb-2">💡 Recommandations :</p>
                    <ul class="list-disc list-inside space-y-1 text-gray-700">
                        {% for rec in cv_analysis.recommendations %}
                        <li>{{ rec }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
            {% endif %}
            {% else %}
            <!-- CV uploadé mais pas encore analysé -->
            <div class="bg-blue-50 p-8 rounded-lg border-2 border-blue-300 text-center">
                <div class="text-6xl mb-4">⏳</div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">CV en cours de traitement</h3>
                <p class="text-gray-600">Le CV a été uploadé mais n'a pas encore été analysé par l'intelligence artificielle.</p>
            </div>
            {% endif %}
        </div>

        <!-- Talents -->
        <div class="section-purple p-8 mb-8">
            <div class="flex items-center gap-3 mb-6">
                <span class="text-4xl">⭐</span>
                <h2 class="text-2xl font-bold text-gray-800">Compétences & Talents</h2>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                {% for user_talent in user.talents %}
                <div class="bg-purple-50 p-4 rounded-xl border-2 border-purple-300 hover:shadow-lg transition-all text-center">
                    <div class="text-4xl mb-2">{{ user_talent.talent.emoji }}</div>
                    <p class="font-semibold text-gray-800">{{ user_talent.talent.name }}</p>
                    <p class="text-xs text-gray-500">{{ user_talent.talent.category }}</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Coordonnées -->
        <div class="section-green p-8 mb-8">
            <div class="flex items-center gap-3 mb-6">
                <span class="text-4xl">📞</span>
                <h2 class="text-2xl font-bold text-gray-800">Coordonnées</h2>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-green-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 mb-1">📧 Email</p>
                    <p class="font-semibold text-gray-800">{{ user.email }}</p>
                </div>
                
                {% if user.phone %}
                <div class="bg-green-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 mb-1">📱 Téléphone</p>
                    <p class="font-semibold text-gray-800">{{ user.phone }}</p>
                </div>
                {% endif %}
                
                {% if user.whatsapp %}
                <div class="bg-green-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 mb-1">💬 WhatsApp</p>
                    <p class="font-semibold text-gray-800">{{ user.whatsapp }}</p>
                </div>
                {% endif %}
                
                {% if user.address %}
                <div class="bg-green-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 mb-1">📍 Adresse</p>
                    <p class="font-semibold text-gray-800">{{ user.address }}</p>
                </div>
                {% endif %}
                
                {% if user.city %}
                <div class="bg-green-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 mb-1">🏙️ Ville</p>
                    <p class="font-semibold text-gray-800">{{ user.city.name }}</p>
                </div>
                {% endif %}
                
                {% if user.country %}
                <div class="bg-green-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 mb-1">🌍 Pays</p>
                    <p class="font-semibold text-gray-800">{{ user.country.name }}</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Informations professionnelles -->
        {% if user.education or user.languages %}
        <div class="section-orange p-8 mb-8">
            <div class="flex items-center gap-3 mb-6">
                <span class="text-4xl">🎓</span>
                <h2 class="text-2xl font-bold text-gray-800">Formation & Langues</h2>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {% if user.education %}
                <div class="bg-orange-50 p-6 rounded-lg border-2 border-orange-300">
                    <p class="text-sm text-gray-600 mb-2 font-semibold">📚 Formation</p>
                    <p class="text-gray-800">{{ user.education }}</p>
                </div>
                {% endif %}
                
                {% if user.languages %}
                <div class="bg-orange-50 p-6 rounded-lg border-2 border-orange-300">
                    <p class="text-sm text-gray-600 mb-3 font-semibold">🌐 Langues parlées</p>
                    <div class="flex flex-wrap gap-2">
                        {% for lang in user.languages.split(',') %}
                        <span class="bg-orange-200 px-3 py-1 rounded-full text-sm font-semibold text-orange-800">
                            {{ lang.strip() }}
                        </span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Réseaux sociaux & Portfolio -->
        {% if user.portfolio_url or user.linkedin or user.github or user.behance or user.dribbble or user.instagram or user.twitter or user.facebook or user.youtube or user.tiktok %}
        <div class="section-pink p-8">
            <div class="flex items-center gap-3 mb-6">
                <span class="text-4xl">🔗</span>
                <h2 class="text-2xl font-bold text-gray-800">Liens & Réseaux Sociaux</h2>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                {% if user.portfolio_url %}
                <a href="{{ user.portfolio_url }}" target="_blank" class="bg-pink-50 p-4 rounded-lg border-2 border-pink-300 hover:shadow-lg transition-all text-center">
                    <p class="text-3xl mb-1">🌐</p>
                    <p class="font-semibold text-gray-800 text-sm">Portfolio</p>
                </a>
                {% endif %}
                
                {% if user.linkedin %}
                <a href="{{ user.linkedin }}" target="_blank" class="bg-pink-50 p-4 rounded-lg border-2 border-pink-300 hover:shadow-lg transition-all text-center">
                    <p class="text-3xl mb-1">💼</p>
                    <p class="font-semibold text-gray-800 text-sm">LinkedIn</p>
                </a>
                {% endif %}
                
                {% if user.github %}
                <a href="{{ user.github }}" target="_blank" class="bg-pink-50 p-4 rounded-lg border-2 border-pink-300 hover:shadow-lg transition-all text-center">
                    <p class="text-3xl mb-1">💻</p>
                    <p class="font-semibold text-gray-800 text-sm">GitHub</p>
                </a>
                {% endif %}
                
                {% if user.behance %}
                <a href="{{ user.behance }}" target="_blank" class="bg-pink-50 p-4 rounded-lg border-2 border-pink-300 hover:shadow-lg transition-all text-center">
                    <p class="text-3xl mb-1">🎨</p>
                    <p class="font-semibold text-gray-800 text-sm">Behance</p>
                </a>
                {% endif %}
                
                {% if user.dribbble %}
                <a href="{{ user.dribbble }}" target="_blank" class="bg-pink-50 p-4 rounded-lg border-2 border-pink-300 hover:shadow-lg transition-all text-center">
                    <p class="text-3xl mb-1">🏀</p>
                    <p class="font-semibold text-gray-800 text-sm">Dribbble</p>
                </a>
                {% endif %}
                
                {% if user.instagram %}
                <a href="{{ user.instagram }}" target="_blank" class="bg-pink-50 p-4 rounded-lg border-2 border-pink-300 hover:shadow-lg transition-all text-center">
                    <p class="text-3xl mb-1">📸</p>
                    <p class="font-semibold text-gray-800 text-sm">Instagram</p>
                </a>
                {% endif %}
                
                {% if user.twitter %}
                <a href="{{ user.twitter }}" target="_blank" class="bg-pink-50 p-4 rounded-lg border-2 border-pink-300 hover:shadow-lg transition-all text-center">
                    <p class="text-3xl mb-1">🐦</p>
                    <p class="font-semibold text-gray-800 text-sm">Twitter/X</p>
                </a>
                {% endif %}
                
                {% if user.facebook %}
                <a href="{{ user.facebook }}" target="_blank" class="bg-pink-50 p-4 rounded-lg border-2 border-pink-300 hover:shadow-lg transition-all text-center">
                    <p class="text-3xl mb-1">👥</p>
                    <p class="font-semibold text-gray-800 text-sm">Facebook</p>
                </a>
                {% endif %}
                
                {% if user.youtube %}
                <a href="{{ user.youtube }}" target="_blank" class="bg-pink-50 p-4 rounded-lg border-2 border-pink-300 hover:shadow-lg transition-all text-center">
                    <p class="text-3xl mb-1">📺</p>
                    <p class="font-semibold text-gray-800 text-sm">YouTube</p>
                </a>
                {% endif %}
                
                {% if user.tiktok %}
                <a href="{{ user.tiktok }}" target="_blank" class="bg-pink-50 p-4 rounded-lg border-2 border-pink-300 hover:shadow-lg transition-all text-center">
                    <p class="text-3xl mb-1">🎵</p>
                    <p class="font-semibold text-gray-800 text-sm">TikTok</p>
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}

    </div>
</div>
{% endblock %}
